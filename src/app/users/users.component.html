<!-- Message Alert -->
<div *ngIf="showMessage" [class]="'message-alert ' + messageType" (click)="closeMessage()">
  <span class="message-icon">{{ messageType === 'success' ? '✅' : '❌' }}</span>
  <span class="message-text">{{ messageText }}</span>
  <button class="message-close" (click)="closeMessage()">×</button>
</div>


<div class="users-container" [class.dark-theme]="isDarkMode">
  <!-- Header -->
  <header class="app-header">
    <div class="header-content">
      <!-- Brand -->
      <div class="brand">
        <h1 class="logo">Users</h1>
        <p class="tagline">Manage system users and permissions</p>
      </div>
      
      <!-- Controls -->
      <div class="header-controls">
        <button class="theme-toggle" (click)="toggleTheme()" [attr.title]="isDarkMode ? 'Switch to light mode' : 'Switch to dark mode'">
          <span class="theme-icon">{{ isDarkMode ? '☀️' : '🌙' }}</span>
          <span class="theme-text">{{ isDarkMode ? 'Light' : 'Dark' }}</span>
        </button>
        
        <button class="profile-btn" (click)="navigateToProfile()">
          <span class="profile-icon">👤</span>
          <span class="profile-text">My Profile</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Dashboard -->
    <div class="dashboard">
      <!-- Statistics -->
      <div class="stats-grid">
        <div class="stat-card total-users">
          <div class="stat-icon">👥</div>
          <div class="stat-info">
            <h3>{{ users.length }}</h3>
            <p>Total Users</p>
          </div>
        </div>
        
        <div class="stat-card admins">
          <div class="stat-icon">👑</div>
          <div class="stat-info">
            <h3>{{ getAdminCount() }}</h3>
            <p>Administrators</p>
          </div>
        </div>
        
        <div class="stat-card regular-users">
          <div class="stat-icon">👤</div>
          <div class="stat-info">
            <h3>{{ getUserCount() }}</h3>
            <p>Regular Users</p>
          </div>
        </div>
      </div>

      <!-- Filters & Actions -->
      <div class="filters-section">
        <!-- Search -->
        <div class="search-box">
          <div class="search-icon">🔍</div>
          <input 
            type="text" 
            [(ngModel)]="searchQuery"
            (input)="filterUsers()"
            placeholder="Search users..." 
            class="search-input"
          />
        </div>
        
        <!-- Filter Controls -->
        <div class="filter-group">
          <select [(ngModel)]="roleFilter" (change)="filterUsers()" class="filter-select">
            <option value="all">All Roles</option>
            <option value="1">Administrators</option>
            <option value="2">Regular Users</option>
          </select>
          
          <button (click)="clearFilters()" class="clear-filters-btn">
            <span>🔄</span>
            Clear Filters
          </button>
          
          <button (click)="createUser()" class="primary-btn create-user-btn">
            <span>➕</span>
            Create New User
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-state">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Loading users...</span>
        </div>
        <p>Loading users...</p>
      </div>

      <!-- Users Grid -->
      <div *ngIf="!isLoading" class="users-grid">
        <!-- User Cards -->
        <div *ngFor="let user of pagedUsers" class="user-card" [class.admin]="user.role_id === 1">
          <!-- Card Header -->
          <div class="user-card-header">
            <div class="user-title-section">
              <h3 class="user-name">{{ user.first_name }} {{ user.last_name }}</h3>
              <span class="role-badge" [class]="'role-' + user.role_id">
                {{ user.role_id === 1 ? 'Admin' : 'User' }}
              </span>
            </div>
            <div class="user-meta">
              <span class="user-id">#{{ user.id }}</span>
            </div>
          </div>

          <!-- User Info -->
          <div class="user-info">
            <div class="info-item">
              <span class="info-label">👤 Username:</span>
              <span class="info-value at-symbol">{{ user.username }}</span>
            </div>
            
            <div class="info-item">
              <span class="info-label">📧 Email:</span>
              <span class="info-value">{{ user.email }}</span>
            </div>
            
            <div class="info-item">
              <span class="info-label">📞 Phone:</span>
              <span class="info-value">{{ user.phone || 'Not provided' }}</span>
            </div>
            
            <div class="info-item">
              <span class="info-label">📅 Joined:</span>
              <span class="info-value">{{ user.created_at | date:'MMM d, y' }}</span>
            </div>
          </div>

          <!-- Card Actions -->
          <div class="user-actions">
            <div class="main-actions">
              <button 
                (click)="editUser(user)"
                class="action-btn edit-btn"
                title="Edit User"
                [disabled]="isSaving"
              >
                <span *ngIf="isSaving" class="spinner-border spinner-border-sm" role="status">
                  <span class="visually-hidden">Loading...</span>
                </span>
                <span *ngIf="!isSaving" class="btn-icon">✏️</span>
                <span class="btn-text">{{ isSaving ? 'Editing...' : 'Edit' }}</span>
              </button>
            </div>

            <div class="utility-actions">
              <button 
                (click)="viewUserDetails(user)"
                class="icon-btn view-btn"
                title="View Details"
              >
                👁️
              </button>
              
              <button 
              *ngIf="user.role_id !== 1"
              (click)="confirmDelete(user.id, user.first_name + ' ' + user.last_name)"
              class="icon-btn delete-btn"
              title="Delete User"
              [disabled]="isDeleting"
              >
              <span *ngIf="isDeleting" class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden">Deleting...</span>
              </span>
              <span *ngIf="!isDeleting">🗑️</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Empty States -->
        <div *ngIf="!isLoading && filteredUsers.length === 0 && users.length > 0" class="empty-state">
          <div class="empty-icon">🔍</div>
          <h3>No users found</h3>
          <p>Try adjusting your search criteria or filters</p>
          <button (click)="clearFilters()" class="primary-btn">Clear All Filters</button>
        </div>

        <div *ngIf="!isLoading && users.length === 0" class="empty-state">
          <div class="empty-icon">👥</div>
          <h3>No users yet</h3>
          <p>There are no users in the system</p>
          <button (click)="createUser()" class="primary-btn">Create First User</button>
        </div>
      </div>

      <!-- Pagination -->
      <div *ngIf="!isLoading && filteredUsers.length > 0" class="pagination-controls">
        <!-- Pagination Info -->
        <div class="pagination-info">
          Showing {{ (currentPage - 1) * itemsPerPage + 1 }} - 
          {{ Math.min(currentPage * itemsPerPage, filteredUsers.length) }} 
          of {{ filteredUsers.length }} users
        </div>
        
        <!-- Pagination Buttons -->
        <div class="pagination-buttons">
          <button 
            (click)="previousPage()" 
            [disabled]="currentPage === 1"
            class="pagination-btn"
          >
            ← Previous
          </button>
          
          <div class="page-numbers">
            <span 
              *ngFor="let page of getPageNumbers()" 
              (click)="goToPage(page)"
              [class.active]="page === currentPage"
              class="page-number"
            >
              {{ page }}
            </span>
            
            <span *ngIf="totalPages > 5 && currentPage < totalPages - 2" class="page-ellipsis">
              ...
            </span>
          </div>
          
          <button 
            (click)="nextPage()" 
            [disabled]="currentPage === totalPages"
            class="pagination-btn"
          >
            Next →
          </button>
        </div>

        <!-- Items Per Page -->
        <div class="items-per-page">
          <label for="itemsPerPage">Items per page:</label>
          <select 
            id="itemsPerPage" 
            [(ngModel)]="itemsPerPage" 
            (change)="onItemsPerPageChange()"
            class="page-select"
          >
            <option value="6">6</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>

      <!-- User Details Modal -->
      <div *ngIf="selectedUser && showUserDetails" class="modal-overlay" (click)="closeUserDetails()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <!-- Modal Header -->
          <div class="modal-header">
            <h2>User Details</h2>
            <button class="modal-close" (click)="closeUserDetails()">×</button>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body">
            <div class="user-details-content">
              <div class="user-avatar-large">
                {{ getUserInitials(selectedUser) }}
              </div>
              
              <!-- Details Grid -->
              <div class="details-grid">
                <div class="detail-row">
                  <span class="detail-label">Full Name:</span>
                  <span class="detail-value">{{ selectedUser.first_name }} {{ selectedUser.last_name }}</span>
                </div>
                
                <div class="detail-row">
                  <span class="detail-label">Username:</span>
                  <span class="detail-value">
                    <div *ngIf="selectedUser">
                      <span class="detail-value">&commat;{{ selectedUser.username }}</span>
                    </div>
                    <div *ngIf="!selectedUser">
                      <p>Select a user to view details</p>
                    </div>
                  </span>
                </div>
                
                <div class="detail-row">
                  <span class="detail-label">Email:</span>
                  <span class="detail-value">{{ selectedUser.email }}</span>
                </div>
                
                <div class="detail-row">
                  <span class="detail-label">Role:</span>
                  <span class="detail-value role-badge" [class]="'role-' + selectedUser.role_id">
                    {{ selectedUser.role_id === 1 ? 'Administrator' : 'Regular User' }}
                  </span>
                </div>
                
                <div class="detail-row">
                  <span class="detail-label">Phone:</span>
                  <span class="detail-value">{{ selectedUser.phone || 'Not provided' }}</span>
                </div>
                
                <div class="detail-row">
                  <span class="detail-label">Joined Date:</span>
                  <span class="detail-value">{{ selectedUser.created_at | date:'fullDate' }}</span>
                </div>
                
                <div class="detail-row" *ngIf="selectedUser.bio">
                  <span class="detail-label">Bio:</span>
                  <span class="detail-value bio-text">{{ selectedUser.bio }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Create/Edit User Modal -->
      <div *ngIf="editingUser" class="modal-overlay" (click)="closeEditModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <!-- Modal Header -->
          <div class="modal-header">
            <h2>{{ isCreating ? 'Create New User' : 'Edit User' }}</h2>
            <button class="modal-close" (click)="closeEditModal()">×</button>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body">
            <form (ngSubmit)="isCreating ? saveUser() : updateUser()" class="edit-form">
              <!-- Name Fields -->
              <div class="form-row">
                <div class="form-group">
                  <label for="edit-first-name">First Name *</label>
                  <input
                    id="edit-first-name"
                    [(ngModel)]="editingUser.first_name"
                    name="first_name"
                    required
                    class="form-input"
                    [disabled]="isSaving"
                  />
                </div>
                
                <div class="form-group">
                  <label for="edit-last-name">Last Name *</label>
                  <input
                    id="edit-last-name"
                    [(ngModel)]="editingUser.last_name"
                    name="last_name"
                    required
                    class="form-input"
                    [disabled]="isSaving"
                  />
                </div>
              </div>
              
              <!-- Account Fields -->
              <div class="form-group">
                <label for="edit-username">Username *</label>
                <input
                  id="edit-username"
                  [(ngModel)]="editingUser.username"
                  name="username"
                  required
                  class="form-input"
                  [disabled]="isSaving"
                />
              </div>
              
              <div class="form-group">
                <label for="edit-email">Email *</label>
                <input
                  id="edit-email"
                  type="email"
                  [(ngModel)]="editingUser.email"
                  name="email"
                  required
                  class="form-input"
                  [disabled]="isSaving"
                />
              </div>
              
              <!-- Contact & Role -->
              <div class="form-row">
                <div class="form-group">
                  <label for="edit-phone">Phone</label>
                  <input
                    id="edit-phone"
                    type="tel"
                    [(ngModel)]="editingUser.phone"
                    name="phone"
                    class="form-input"
                    [disabled]="isSaving"
                  />
                </div>
                
                <div class="form-group">
                  <label for="edit-role">Role *</label>
                  <select
                    id="edit-role"
                    [(ngModel)]="editingUser.role_id"
                    name="role_id"
                    class="form-select"
                    required
                    [disabled]="isSaving"
                  >
                    <option value="2">Regular User</option>
                    <option value="1">Administrator</option>
                  </select>
                </div>
              </div>
              
              <!-- Password Fields -->
              <div class="form-group" *ngIf="isCreating">
                <label for="edit-password">Password *</label>
                <input
                  id="edit-password"
                  type="password"
                  [(ngModel)]="editingUser.password"
                  name="password"
                  required
                  class="form-input"
                  [disabled]="isSaving"
                />
              </div>
              
              <div class="form-group" *ngIf="isCreating">
                <label for="edit-password-confirm">Confirm Password *</label>
                <input
                  id="edit-password-confirm"
                  type="password"
                  [(ngModel)]="editingUser.password_confirmation"
                  name="password_confirmation"
                  required
                  class="form-input"
                  [disabled]="isSaving"
                />
              </div>
              
              <!-- Bio Field -->
              <div class="form-group">
                <label for="edit-bio">Bio</label>
                <textarea
                  id="edit-bio"
                  [(ngModel)]="editingUser.bio"
                  name="bio"
                  rows="3"
                  class="form-textarea"
                  placeholder="Tell us about yourself..."
                  [disabled]="isSaving"
                ></textarea>
              </div>
              
              <!-- Form Actions -->
              <div class="form-actions">
                <button type="submit" class="modal-btn save-btn" [disabled]="isSaving">
                  <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  {{ isSaving ? 'Saving...' : (isCreating ? 'Create User' : 'Save Changes') }}
                </button>
                <button type="button" (click)="closeEditModal()" class="modal-btn cancel-btn" [disabled]="isSaving">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
