<div class="container-fluid px-0">
  <!-- Message Overlay -->
  <div *ngIf="showMessage" class="message-overlay" [ngClass]="messageType">
    <div class="message-content">
      <i class="fas" [ngClass]="messageType === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'"></i>
      {{ messageText }}
    </div>
  </div>
  
  <div class="profile-manager">
    <div class="execution-header">
      <div class="search-container">
        <input type="text" class="search-input" placeholder="Search by name, address or bio..." [(ngModel)]="searchQuery" (keydown)="onSearchKeydown($event)">
        <div class="search-results" *ngIf="searchQuery && !isSearching">
          <div class="search-item" *ngFor="let result of searchResults" (click)="showProfileDetails(result)">
            <span>{{result.name}}</span>
            <small>{{result.adresse || 'No address'}}</small>
            <div class="profile-info">
              <small>Bio: {{result.bio}}</small>
            </div>
          </div>
          <div class="no-results" *ngIf="searchResults.length === 0">
            No results found
          </div>
        </div>
      </div>
      <button class="search-btn gradient-btn" (click)="searchProfiles()" [disabled]="isSearching">
        <i class="fas fa-search" *ngIf="!isSearching"></i>
        <div class="btn-loader" *ngIf="isSearching"></div>
        {{isSearching ? 'Searching...' : 'Search Profiles'}}
      </button>
      <button class="clear-btn" (click)="clearSearch()" *ngIf="searchQuery">
        Clear
      </button>
      <button class="count-btn" (click)="getProfileCount()" [disabled]="isCountLoading">
        <div class="btn-loader" *ngIf="isCountLoading"></div>
        {{isCountLoading ? 'Loading...' : 'Profiles: ' + profileCount}}
      </button>
      <button class="theme-btn" (click)="toggleTheme()">
        <i class="fas" [ngClass]="isDarkMode ? 'fa-sun' : 'fa-moon'"></i>
        {{ isDarkMode ? 'Light' : 'Dark' }}
      </button>
    </div>

    <!-- Single Profile View -->
    <div *ngIf="showSingleProfile && selectedProfile" class="single-profile-view">
      <div class="profile-detail-card">
        <h3>Profile #{{selectedProfile.id}} {{selectedProfile.name}}</h3>
        <div class="detail-row">
          <span class="detail-label">ID:</span>
          <span class="detail-value">{{ selectedProfile.id || 'No ID' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Name:</span>
          <span class="detail-value">{{ selectedProfile.name || 'No name' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Address:</span>
          <span class="detail-value">{{ selectedProfile.adresse || 'No address' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Avatar:</span>
          <span class="detail-value">{{ selectedProfile.avatar || 'No avatar' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Birthdate:</span>
          <span class="detail-value">{{ selectedProfile.birthdate ? (selectedProfile.birthdate | date: 'short') : 'No birthdate' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Bio:</span>
          <span class="detail-value">{{ selectedProfile.bio || 'No bio' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">User ID:</span>
          <span class="detail-value">{{ selectedProfile.user_id || 'No user ID' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Created At:</span>
          <span class="detail-value">{{ selectedProfile.created_at ? (selectedProfile.created_at | date: 'short') : 'No date' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Updated At:</span>
          <span class="detail-value">{{ selectedProfile.updated_at ? (selectedProfile.updated_at | date: 'short') : 'No date' }}</span>
        </div>
        <div class="action-buttons">
          <button (click)="showSingleProfile = false" class="back-button">Back to List</button>
        </div>
      </div>
    </div>

    <!-- Profile List View -->
    <div *ngIf="!showSingleProfile">
      <div class="profile-form" [ngClass]="{'dark-theme': isDarkMode}">
        <input [(ngModel)]="newProfile.name" placeholder="Name" required>
        <input [(ngModel)]="newProfile.adresse" placeholder="Address">
        <input [(ngModel)]="newProfile.avatar" placeholder="Avatar URL">
        <input [(ngModel)]="newProfile.birthdate" type="date" placeholder="Birthdate">
        <textarea [(ngModel)]="newProfile.bio" placeholder="Bio"></textarea>
        <div class="form-actions">
          <button *ngIf="!isEditing" (click)="addProfile()" [disabled]="isAdding">
            <span *ngIf="isAdding" class="loader"></span>
            {{ isAdding ? 'Adding...' : 'Add Profile' }}
          </button>
          <button *ngIf="isEditing" (click)="updateProfile()" [disabled]="isUpdating">
            <span *ngIf="isUpdating" class="loader"></span>
            {{ isUpdating ? 'Updating...' : 'Update Profile' }}
          </button>
          <button *ngIf="isEditing" (click)="resetForm()">Cancel</button>
        </div>
      </div>

      <div class="profile-list">
        <div *ngIf="isLoading" class="loading-container">
          <div class="spinner"></div>
          <p>Loading profiles...</p>
        </div>
        <div class="profile-list" [ngClass]="{'dark-theme': isDarkMode}">
        <table class="profile-table" *ngIf="!isLoading">
          <thead>
            <tr>
              <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef>ID</th>
                <td mat-cell *matCellDef="let profile">{{ profile.id }}</td>
              </ng-container>
              <th (click)="sortProfiles('id')" class="sortable">
                ID 
                <span *ngIf="sortColumn === 'id'" class="sort-arrow">
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                </span>
              </th>
              <th (click)="sortProfiles('name')" class="sortable">
                Name 
                <span *ngIf="sortColumn === 'name'" class="sort-arrow">
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                </span>
              </th>
              <th (click)="sortProfiles('adresse')" class="sortable">
                Address 
                <span *ngIf="sortColumn === 'adresse'" class="sort-arrow">
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                </span>
              </th>
              <th (click)="sortProfiles('avatar')" class="sortable">
                Avatar 
                <span *ngIf="sortColumn === 'avatar'" class="sort-arrow">
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                </span>
              </th>
              <th (click)="sortProfiles('birthdate')" class="sortable">
                Birthdate 
                <span *ngIf="sortColumn === 'birthdate'" class="sort-arrow">
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                </span>
              </th>
              <th (click)="sortProfiles('bio')" class="sortable">
                Bio 
                <span *ngIf="sortColumn === 'bio'" class="sort-arrow">
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                </span>
              </th>
              <th (click)="sortProfiles('user_id')" class="sortable">
                User_id 
                <span *ngIf="sortColumn === 'user_id'" class="sort-arrow">
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                </span>
              </th>
              <th (click)="sortProfiles('created_at')" class="sortable">
                Created At 
                <span *ngIf="sortColumn === 'created_at'" class="sort-arrow">
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                </span>
              </th>
              <th (click)="sortProfiles('updated_at')" class="sortable">
                Updated At 
                <span *ngIf="sortColumn === 'updated_at'" class="sort-arrow">
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                </span>
              </th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let profile of profiles" (click)="showProfileDetails(profile)" class="clickable-row">
              <td>{{ profile.id }}</td>
              <td>{{ profile.name }}</td>
              <td>{{ profile.adresse || 'No address' }}</td>
              <td>{{ profile.avatar || 'No avatar' }}</td>
              <td>{{ profile.birthdate | date: 'short' }}</td>
              <td>{{ profile.bio || 'No bio' }}</td>
              <td>{{ profile.user_id }}</td>
              <td>{{ profile.created_at | date: 'short' }}</td>
              <td>{{ profile.updated_at | date: 'short' }}</td>
              <td class="actions">
                <button (click)="editProfile(profile); $event.stopPropagation()">Edit</button>
                <button (click)="deleteProfile(profile.id); $event.stopPropagation()" [disabled]="isDeleting">
                  <span *ngIf="isDeleting" class="loader"></span>
                  {{ isDeleting ? 'Deleting...' : 'Delete' }}
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
